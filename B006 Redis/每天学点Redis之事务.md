# 7.事务

## 7.1 什么是事务？

事务是指是程序中一系列严密的逻辑操作，而且所有操作必须全部成功完成，否则在每个操作中所作的所有更改都会被撤消。

### 7.1.1 四大特性

- A（Atomicity）：原子性
- C（Consistency）：一致性
- I（Isolation）：隔离性
- D（Durability）：持久性

### 7.1.2 隔离级别

- Read uncommitted：读未提交。
- Read committed：读提交。
- Repeatable read：重复读。
- Serializable：序列化



## 7.2 什么是 Redis 事务？

> 事务可以一次执行多个命令， 并且带有以下两个重要的保证：
>
> - 事务是一个**单独的隔离**操作
>   - 事务中的所有命令都会**序列化**、**按顺序**地执行。
>   - 事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。
> - 事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行

说明

- 批量操作在发送 EXEC 命令前被放入队列缓存。
- 收到 EXEC 命令后进入事务执行，事务中**任意命令执行失败，其余的命令依然被执行**。
- 在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中。（本质是一组命令的集合。一个事务中的所有命令都会序列化，按顺序地串行化执行而不会被其它命令插入）



## 7.3 Redis 事务的三个阶段

- 开始事务（multi）
- 命令入队（command）
- 执行事务（exec）或取消事务（discard）

| 命令    | 描述                                 |
| ------- | ------------------------------------ |
| multi   | 标记事务块的开始                     |
| exec    | 执行事务块内所有的命令               |
| discard | 取消事务，放弃执行事务块内的所有命令 |

测试：

```shell
multi
# OK
set tSet "a"
# QUEUED
get tSet
# QUEUED
sadd tSzet "b"
# QUEUED
smembers tSzet
#QUEUED
exec
# 1) OK
# 2) "a"
# 3) (integer) 1
# 4) 1) "b"
```



## 7.4 带 Watch 的事务

作用：在事务开始之前监视任意数量的键，当调用`EXEC`命令执行事务时， 如果任意一个被监视的键已经被其他客户端修改了， 那么整个事务将被打断，不再执行， 直接返回失败。

- watch 命令可以被调用多次

- 对键的监视从 watch 执行之后开始生效， 直到调用 exec 为止（不管事务是否成功执行，所有键的监视都会被取消）
- 当客户端断开连接时， 该客户端对键的监视也会被取消

| 命令                | 描述                                                 |
| ------------------- | ---------------------------------------------------- |
| watch key [key ...] | 监听key。如果事务执行之前，key发生变动，事务将被打断 |
| unwatch             | 取消对所有 key 的监视                                |

测试：用户A和用户B使用同一个银行卡消费

不使用 watch 的事务

```shell
# 用户A 充值 100
set balance 100
# "OK"

# 用户B 购物 100
multi
decrby balance 100

# 用户A 同时消费 100
decrby balance 100
# (integer) 0 余额清空

# 用户B 结账 100
exec
# 1) (integer) -100 消费成功，余额为负
```

使用 watch 的事务

```shell
# 用户A 充值 100
set balance 100
# "OK"

# 用户B 购物 100
watch balance
multi
decrby balance 100

# 用户A 同时消费 100
decrby balance 100
# (integer) 0 余额清空

# 用户B 结账 100
exec
# (nil) 执行失败

# 用户B 查看余额
get balance
# "0"
```



## 7.5 小结

### 7.5.1 3个阶段

- 开启事务：`mulit`
- 入队：多个命令入队到事务队列中，并不会立即执行
- 执行触发事务： `exec` 命令触发事务

### 7.5.2 3个特性

- **隔离性**：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。
- **不保证原子性**：**单个 Redis 命令的执行是原子性的**，但是同一个事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚

## 7.6 拓展

### watch 事务的实现原理

- [不支持原子性的 Redis 事务也敢叫事务？](https://zhuanlan.zhihu.com/p/235466985)